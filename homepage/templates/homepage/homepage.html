{% extends "base.html" %}
{% load static %}

{% block page_title %}
Inventory Overview
{% endblock %}


{% block content %}
<link rel="stylesheet" href="{% static 'css/homepage.css' %}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>



<div class="carousel-container">
    <div class="carousel-viewport">
        <div class="carousel-track">
            {% for item in items %}
                <div class="carousel-item">
                    <div class="item-name">{{ item.name }}</div>
                    {% if item.image %}
                        <img src="{{ item.image.url }}" class="item-image" alt="{{ item.name }}"onerror="handleImageError(this)">
                    {% else %}
                        <div class="no-image">
                            <div class="no-image-icon">ğŸ“·</div>
                            <p>No Image</p>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <div class="carousel-item">
                    <div class="item-name">No Items</div>
                    <div class="no-image">
                        <div class="no-image-icon">ğŸ“¦</div>
                        <p>Currently no items</p>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- å°èˆªæŒ‰éˆ• -->
    <button class="nav-button prev" onclick="carousel.prev()">â®</button>
    <button class="nav-button next" onclick="carousel.next()">â¯</button>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="info-display">
            <span class="current-info" id="currentInfo">1 / {{ items|length|default:1 }}</span>
            <span>|</span>
            <span id="currentItemName">
                {% if items %}{{ items.0.name }}{% else %}No Items{% endif %}
            </span>
        </div>
        
        <div class="indicators" id="indicators"></div>
        
        {% if items|length > 1 %}
        <button class="auto-play-btn" id="autoPlayBtn" onclick="carousel.toggleAutoPlay()">
            Auto Play
        </button>
        {% endif %}
    </div>
</div>

<!-- å…¶ä»–å…§å®¹ä¿æŒä¸è®Š -->
<!-- {% if form %}
<div class="box">
    <h3>æ–°å¢é …ç›®</h3>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">æ–°å¢</button>
    </form>
</div>
{% endif %} -->

<div class="inventory-stats">
    <div class="stats-header">
        <h2>ğŸ“Š Inventory Statistics</h2>
        <p>Item quantity distribution and stock status</p>
    </div>
    
    <div class="stats-content">
        <!-- åœ“é¤…åœ– -->
        <div class="chart-container">
            {% if items %}
                <div class="chart-wrapper">
                    <canvas id="inventoryChart"></canvas>
                </div>
                <div class="chart-legend" id="chartLegend">
                    <!-- åœ–ä¾‹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
            {% else %}
                <div class="empty-chart">
                    <div class="empty-chart-icon">ğŸ“ˆ</div>
                    <h3>No Data</h3>
                    <p>No inventory data available</p>
                </div>
            {% endif %}
        </div>
        
        <!-- çµ±è¨ˆä¿¡æ¯ -->
        <div class="stats-info">
            <div class="stat-item">
                <h3>ğŸ“¦ Total Quantity</h3>
                <div class="stat-value" id="totalQuantity">0</div>
                <p class="stat-description">Total quantity of all items</p>
            </div>
            
            <div class="stat-item">
                <h3>ğŸ·ï¸ Items With Images</h3>
                <div class="stat-value" id="itemsWithImages">0</div>
                <p class="stat-description">Number of items with images</p>
            </div>
            
            <div class="stat-item">
                <h3>ğŸ“· Items Without Images</h3>
                <div class="stat-value" id="itemsWithoutImages">0</div>
                <p class="stat-description">Number of items without images</p>
            </div>
            
            <div class="stat-item">
                <h3>ğŸ“Š Completion Rate</h3>
                <div class="stat-value" id="completionRate">0%</div>
                <p class="stat-description">Percentage of complete item data</p>
            </div>
        </div>
    </div>
</div>


<script>
class HorizontalCarousel {
    constructor() {
        this.track = document.querySelector('.carousel-track');
        this.items = document.querySelectorAll('.carousel-item');
        this.indicators = document.getElementById('indicators');
        this.currentInfo = document.getElementById('currentInfo');
        this.currentItemName = document.getElementById('currentItemName');
        this.autoPlayBtn = document.getElementById('autoPlayBtn');
        
        this.currentIndex = 0;
        this.totalItems = this.items.length;
        this.itemWidth = 270; // 250px + 20px margin
        this.visibleItems = this.calculateVisibleItems();
        this.isAutoPlaying = false;
        this.autoPlayInterval = null;
        
        // å¦‚æœåªæœ‰ä¸€å€‹é …ç›®ï¼Œä¸éœ€è¦åˆå§‹åŒ–è¼ªæ’­åŠŸèƒ½
        if (this.totalItems <= 1) {
            this.hideControls();
            return;
        }
        
        this.init();
    }
    
    hideControls() {
        const navButtons = document.querySelectorAll('.nav-button');
        navButtons.forEach(btn => btn.style.display = 'none');
        
        if (this.autoPlayBtn) {
            this.autoPlayBtn.style.display = 'none';
        }
    }
    
    init() {
        this.createIndicators();
        this.updateDisplay();
        this.setupEventListeners();
        this.updateLayout();
    }
    
    calculateVisibleItems() {
        const containerWidth = document.querySelector('.carousel-viewport').offsetWidth;
        return Math.floor(containerWidth / this.itemWidth);
    }
    
    createIndicators() {
        this.indicators.innerHTML = '';
        for (let i = 0; i < this.totalItems; i++) {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            if (i === 0) indicator.classList.add('active');
            indicator.addEventListener('click', () => this.goToSlide(i));
            this.indicators.appendChild(indicator);
        }
    }
    
    setupEventListeners() {
        // éµç›¤æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') this.prev();
            if (e.key === 'ArrowRight') this.next();
            if (e.key === ' ') {
                e.preventDefault();
                this.toggleAutoPlay();
            }
        });
        
        // éŸ¿æ‡‰å¼èª¿æ•´
        window.addEventListener('resize', () => {
            this.visibleItems = this.calculateVisibleItems();
            this.updateLayout();
        });
        
        // æ»‘é¼ æ‡¸åœæš«åœè‡ªå‹•æ’­æ”¾
        const container = document.querySelector('.carousel-container');
        container.addEventListener('mouseenter', () => {
            if (this.isAutoPlaying) this.pauseAutoPlay();
        });
        
        container.addEventListener('mouseleave', () => {
            if (this.isAutoPlaying) this.resumeAutoPlay();
        });
    }
    
    updateLayout() {
        const translateX = -this.currentIndex * this.itemWidth;
        this.track.style.transform = `translateX(${translateX}px)`;
    }
    
    updateDisplay() {
        // æ›´æ–°æŒ‡ç¤ºå™¨
        const indicators = this.indicators.querySelectorAll('.indicator');
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === this.currentIndex);
        });
        
        // æ›´æ–°è³‡è¨Šé¡¯ç¤º
        this.currentInfo.textContent = `${this.currentIndex + 1} / ${this.totalItems}`;
        
        // æ›´æ–°ç•¶å‰ç‰©å“åç¨±
        const currentItem = this.items[this.currentIndex];
        const itemName = currentItem.querySelector('.item-name').textContent;
        this.currentItemName.textContent = itemName;
    }
    
    goToSlide(index) {
        this.currentIndex = index;
        this.updateLayout();
        this.updateDisplay();
    }
    
    next() {
        // å¾ªç’°åˆ°ç¬¬ä¸€å¼µ
        this.currentIndex = (this.currentIndex + 1) % this.totalItems;
        this.updateLayout();
        this.updateDisplay();
    }
    
    prev() {
        // å¾ªç’°åˆ°æœ€å¾Œä¸€å¼µ
        this.currentIndex = (this.currentIndex - 1 + this.totalItems) % this.totalItems;
        this.updateLayout();
        this.updateDisplay();
    }
    
    toggleAutoPlay() {
        if (this.isAutoPlaying) {
            this.stopAutoPlay();
        } else {
            this.startAutoPlay();
        }
    }
    
    startAutoPlay() {
        this.isAutoPlaying = true;
        this.autoPlayBtn.textContent = 'Pause';
        this.autoPlayBtn.classList.remove('paused');
        
        this.autoPlayInterval = setInterval(() => {
            this.next();
        }, 3000);
    }
    
    stopAutoPlay() {
        this.isAutoPlaying = false;
        this.autoPlayBtn.textContent = 'Auto Play';
        this.autoPlayBtn.classList.add('paused');
        
        if (this.autoPlayInterval) {
            clearInterval(this.autoPlayInterval);
            this.autoPlayInterval = null;
        }
    }
    
    pauseAutoPlay() {
        if (this.autoPlayInterval) {
            clearInterval(this.autoPlayInterval);
            this.autoPlayInterval = null;
        }
    }
    
    resumeAutoPlay() {
        if (this.isAutoPlaying && !this.autoPlayInterval) {
            this.autoPlayInterval = setInterval(() => {
                this.next();
            }, 3000);
        }
    }
}

// åœ“é¤…åœ–é¡åˆ¥
class InventoryChart {
    constructor() {
        this.canvas = document.getElementById('inventoryChart');
        this.legendContainer = document.getElementById('chartLegend');
        this.chart = null;
        
        if (this.canvas) {
            this.initChart();
            this.updateStats();
        }
    }
    
    initChart() {
        // å¾ Django æ¨¡æ¿ç²å–ã€Œæ‰€æœ‰å­˜è²¨é …ç›®ã€æ•¸æ“š
        const items = [
            {% for item in items %}
            {
                name: "{{ item.name|escapejs }}",
                quantity: {{ item.quantity|default:0 }}, // ç¢ºä¿æ¯å€‹ç‰©å“æœ‰ quantity å­—æ®µ
                hasImage: {% if item.image %}true{% else %}false{% endif %}
            },
            {% endfor %}
        ];
        
        // è™•ç†æ•¸æ“šï¼šæ¯å€‹å­˜è²¨é …ç›®ç¨ç«‹é¡¯ç¤º
        const inventoryData = this.processInventoryData(items);
        
        // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
        if (items.length === 0) {
            this.showEmptyState();
            return;
        }
        
        // å‹•æ…‹ç”Ÿæˆé¡è‰² (æ¯å€‹å­˜è²¨é …ç›®ä¸€å€‹é¡è‰²)
        const generateColors = (count) => {
            const colorPalette = [
                '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f',
                '#edc948', '#b07aa1', '#ff9da7', '#9c755f', '#bab0ac',
                '#8cd17d', '#86bcb6', '#f1ce63', '#d37295', '#b3b3b3',
                '#a0dbe8', '#fabfd2', '#d4a6c8', '#ffd700', '#a0e662'
            ];
            // å¦‚æœå­˜è²¨é …ç›®è¶…éé¡è‰²æ•¸é‡ï¼Œå¾ªç’°ä½¿ç”¨
            return Array.from({length: count}, (_, i) => colorPalette[i % colorPalette.length]);
        };
        
        const ctx = this.canvas.getContext('2d');
        this.chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: inventoryData.labels,
                datasets: [{
                    data: inventoryData.values,
                    backgroundColor: generateColors(items.length),
                    borderWidth: 2,
                    borderColor: '#fff',
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: false // éš±è—é»˜èªåœ–ä¾‹ï¼Œä½¿ç”¨è‡ªå®šç¾©åœ–ä¾‹
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                return `${context.label}: ${context.raw} pcs`;
                            }
                        }
                    }
                },
                cutout: '65%'
            }
        });
        
        this.createCustomLegend(inventoryData);
    }
    
    processInventoryData(items) {
        // ç›´æ¥ä½¿ç”¨å­˜è²¨é …ç›®åç¨±å’Œæ•¸é‡
        return {
            labels: items.map(item => item.name),
            values: items.map(item => item.quantity),
            total: items.reduce((sum, item) => sum + item.quantity, 0)
        };
    }
    
    createCustomLegend(data) {
        this.legendContainer.innerHTML = '';
        
        data.labels.forEach((label, i) => {
            const value = data.values[i];
            const color = this.chart.data.datasets[0].backgroundColor[i];
            
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `
                <span class="legend-color" style="background:${color}"></span>
                <span class="legend-label">${label}</span>
                <span class="legend-value">${value} pcs</span>
            `;
            this.legendContainer.appendChild(legendItem);
        });
    }
    
    showEmptyState() {
        this.canvas.style.display = 'none';
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'empty-chart';
        emptyDiv.innerHTML = `
            <div class="empty-chart-icon">ğŸ“¦</div>
            <p>No inventory data</p>
        `;
        this.canvas.parentElement.appendChild(emptyDiv);
    }
    
    updateStats() {
        // å¾ DOM ç›´æ¥ç²å–æ‰€æœ‰ç‰©å“å…ƒç´ 
        const itemElements = document.querySelectorAll('.carousel-item');
        let totalQuantity = 0;
        let itemsWithImages = 0;
        let itemsWithoutImages = 0;

        // å¾ Django æ¨¡æ¿è®Šé‡ç²å–åŸå§‹æ•¸æ“š
        const items = [
            {% for item in items %}
            {
                name: "{{ item.name|escapejs }}",
                quantity: {{ item.quantity|default:0 }},
                hasImage: {% if item.image %}true{% else %}false{% endif %}
            },
            {% endfor %}
        ];

        // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
        items.forEach(item => {
            totalQuantity += item.quantity;
            if (item.hasImage) {
                itemsWithImages++;
            } else {
                itemsWithoutImages++;
            }
        });

        const completionRate = items.length > 0 
            ? Math.round((itemsWithImages / items.length) * 100) 
            : 0;

        // æ›´æ–° DOM
        document.getElementById('totalQuantity').textContent = totalQuantity;
        document.getElementById('itemsWithImages').textContent = itemsWithImages;
        document.getElementById('itemsWithoutImages').textContent = itemsWithoutImages;
        document.getElementById('completionRate').textContent = `${completionRate}%`;
    }
}

// åœ–ç‰‡è¼‰å…¥éŒ¯èª¤è™•ç†
function handleImageError(img) {
    const container = img.parentElement;
    const itemName = container.querySelector('.item-name').textContent;
    
    img.style.display = 'none';
    
    const noImageDiv = document.createElement('div');
    noImageDiv.className = 'no-image';
    noImageDiv.innerHTML = `
        <div class="no-image-icon">âŒ</div>
        <p>Image load failed</p>
    `;
    
    container.appendChild(noImageDiv);
}

// åˆå§‹åŒ–
let carousel;
let inventoryChart;

document.addEventListener('DOMContentLoaded', function() {
    carousel = new HorizontalCarousel();
    inventoryChart = new InventoryChart();
});
</script>

{% endblock %}